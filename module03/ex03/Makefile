NAME  = main
CC = avr-gcc
CPU = atmega328p
F_CPU = 16000000UL
BAUD = 115200
PORT = /dev/ttyUSB0
LIB = ./utils/

SRC = $(NAME).c $(LIB)usart.c $(LIB)led.c $(LIB)timer1.c  # ‚úÖ Ajout des fichiers source
#OBJ = $(SRC:.c=.o)  # ‚úÖ G√©n√®re la liste des fichiers objets (.o)
OBJ = $(NAME).o $(LIB)usart.o $(LIB)led.o $(LIB)timer1.o


CFLAGS = -mmcu=$(CPU) -DF_CPU=$(F_CPU) -Os  # ‚úÖ Options de compilation
LDFLAGS =  # ‚úÖ Pas de librairies additionnelles pour l'instant

all: flash  # ‚úÖ Compilation et flash en une seule commande

$(NAME).elf: $(OBJ)  
	@echo "üîó‚ú® Linker tous les objets"
	$(CC) $(CFLAGS) -o $(NAME).elf $(OBJ) $(LDFLAGS)  

utils/%.o: utils/%.c
	@echo "üõ†Ô∏èüì¶ Compilation s√©par√©e de chaque fichier source"
	$(CC) $(CFLAGS) -c $< -o $@  

hex: $(NAME).elf
	@echo "üì¶‚û°Ô∏èüî¢ Conversion en format .hex"
	avr-objcopy -O ihex $(NAME).elf $(NAME).hex  

flash: hex
	@echo "üöÄ‚ö° Flash via avrdude" 
	avrdude -c arduino -p m328p -U flash:w:$(NAME).hex:i -P $(PORT) -b $(BAUD)  

clean:
	@echo "üßπüóëÔ∏è Suppression propre des fichiers objets et binaires"
	rm -f *.hex *.elf *.o
	rm -f $(LIB)*.o   
